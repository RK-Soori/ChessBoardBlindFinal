<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Chess System | Responsive</title>
    
    <!-- LIBRARIES -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.js"></script>
    
    <!-- FIREBASE SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <!-- STYLES -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- ICONS -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-body: #0f172a;
            --bg-panel: #1e293b;
            --bg-element: #334155;
            --accent-primary: #3b82f6;
            --accent-success: #10b981;
            --accent-danger: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border-color: rgba(255, 255, 255, 0.08);

            /* DYNAMIC THEME VARIABLES (Default: Slate) */
            --board-white: #f0f9ff;
            --board-black: #475569;
        }

        /* THEME PRESETS */
        .theme-green { --board-white: #eeeed2; --board-black: #769656; }
        .theme-blue { --board-white: #e3f2fd; --board-black: #2196f3; }
        .theme-brown { --board-white: #f0d9b5; --board-black: #b58863; }
        .theme-purple { --board-white: #f3e5f5; --board-black: #9c27b0; }

        * { box-sizing: border-box; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-primary);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* --- RESPONSIVE MAIN CONTAINER --- */
        .dashboard-container {
            display: flex;
            flex-wrap: wrap; /* Allows stacking on mobile */
            gap: 20px;
            width: 100%;
            max-width: 1600px;
            padding: 20px;
            justify-content: center;
            align-items: flex-start;
        }

        /* --- LEFT PANEL: BOARD --- */
        .board-section {
            flex: 2; /* Takes up 2 parts of width */
            min-width: 300px; /* Minimum width before shrinking */
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
        }

        /* --- RIGHT PANEL: SIDEBAR --- */
        .sidebar {
            flex: 1; /* Takes up 1 part of width */
            min-width: 300px;
            max-width: 450px;
            background: var(--bg-panel);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            /* Make sidebar sticky on desktop */
            position: sticky;
            top: 20px; 
        }

        /* --- HEADER & TOOLBAR --- */
        .header-title {
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Allow wrapping on small phones */
            gap: 10px;
        }
        
        .header-title h1 { 
            font-size: 1.5rem; 
            margin: 0; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            white-space: nowrap;
        }
        
        .toolbar {
            display: flex;
            gap: 10px;
        }

        select.theme-select {
            background: var(--bg-element);
            color: white;
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            border-radius: 8px;
            outline: none;
            cursor: pointer;
            font-family: 'Inter', sans-serif;
        }

        /* --- BOARD WRAPPER --- */
        .board-wrapper {
            display: flex;
            gap: 10px;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        .board-container-inner {
            /* FIXED SIZING LOGIC */
            width: 100%;
            /* Limiting max-width by VH (Viewport Height) forces the square to shrink 
               if the screen is short, leaving room for the input bar below. */
            max-width: 60vh; 
            aspect-ratio: 1 / 1;
            margin: 0 auto;
        }

        #boardContainer {
            width: 100%;
            height: 100%;
        }

        /* EVAL BAR */
        .eval-bar-container {
            width: 20px;
            background: #333;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            position: relative;
        }

        .eval-fill { width: 100%; height: 50%; background: #fff; transition: height 0.5s ease; }
        .eval-score { position: absolute; top: 5px; left: 0; width: 100%; text-align: center; font-size: 0.6rem; color: #fff; font-weight: bold; text-shadow: 0 1px 2px #000; z-index: 10; }
        .eval-score.bottom { top: auto; bottom: 5px; color: #333; text-shadow: none; }

        /* --- SIDEBAR WIDGETS --- */
        .status-card {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid var(--accent-primary);
            color: var(--accent-primary);
            padding: 1rem;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .terminal-window {
            background: #000;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid #333;
        }
        
        .terminal-header {
            font-size: 0.75rem;
            color: #666;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
        }
        .terminal-content { color: #10b981; font-size: 0.9rem; word-break: break-all; }
        .blink { animation: blinker 1s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }

        /* HISTORY TABLE */
        .history-container {
            flex-grow: 1;
            background: var(--bg-body);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 250px;
            max-height: 400px; /* Limit height on desktop */
            border: 1px solid var(--border-color);
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            background: var(--bg-element);
            padding: 0.75rem;
            font-size: 0.8rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
        }

        .history-list {
            overflow-y: auto;
            flex-grow: 1;
            padding: 0;
            margin: 0;
            list-style: none;
        }

        .history-row {
            display: grid;
            grid-template-columns: 40px 1fr 1fr;
            padding: 0.5rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }
        .history-row:nth-child(even) { background: rgba(255,255,255,0.02); }
        .move-num { color: var(--text-secondary); }
        .move-white, .move-black { font-weight: 500; font-family: 'JetBrains Mono', monospace;}

        /* CSS Variables for Chessboard colors */
        .white-1e1d7 { background-color: var(--board-white); color: var(--board-black); }
        .black-3c85d { background-color: var(--board-black); color: var(--board-white); }

        /* CONTROLS */
        .btn {
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            color: white;
            font-size: 0.9rem;
        }
        .btn:hover { filter: brightness(110%); transform: translateY(-1px); }
        
        .btn-primary { background: var(--accent-primary); }
        .btn-secondary { background: var(--bg-element); border: 1px solid var(--border-color); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--accent-danger); border: 1px solid var(--accent-danger); width: 100%; }
        
        .input-area {
            width: 100%;
            display: flex;
            gap: 10px;
            margin-top: 15px;
            /* Ensure this stays visible */
            padding-bottom: 5px;
        }

        input[type="text"] {
            background: var(--bg-body);
            border: 1px solid var(--bg-element);
            color: white;
            padding: 12px;
            border-radius: 8px;
            flex-grow: 1;
            font-family: 'JetBrains Mono', monospace;
            outline: none;
        }

        /* --- MOBILE SPECIFIC TWEAKS --- */
        @media (max-width: 900px) {
            .dashboard-container {
                flex-direction: column; /* Stack vertically */
                padding: 10px; /* Reduce padding */
            }
            
            .board-section, .sidebar {
                width: 100%; /* Full width */
                min-width: 0; /* Allow shrinking */
            }

            .sidebar {
                position: static; /* No sticky on mobile */
            }

            .board-container-inner {
                /* Aggressive resizing for mobile landscape/portrait */
                width: 100%;
                max-width: 60vh; 
                aspect-ratio: 1 / 1;
            }
            
            .header-title h1 { font-size: 1.2rem; }
            .btn { padding: 8px 12px; font-size: 0.8rem; }
        }
    </style>
</head>
<body class="theme-slate">

    <div class="dashboard-container">
        
        <!-- LEFT PANEL: CHESS BOARD -->
        <div class="board-section">
            <div class="header-title">
                <h1><i class="ph-fill ph-crown"></i> Smart Chess</h1>
                
                <div class="toolbar">
                    <select class="theme-select" onchange="changeTheme(this.value)">
                        <option value="theme-slate">Slate</option>
                        <option value="theme-green">Green</option>
                        <option value="theme-blue">Blue</option>
                        <option value="theme-brown">Wood</option>
                        <option value="theme-purple">Purple</option>
                    </select>
                    <button class="btn btn-secondary" onclick="flipBoard()">
                        <i class="ph-bold ph-arrows-left-right"></i>
                    </button>
                </div>
            </div>

            <div class="board-wrapper">
                <!-- Stockfish Evaluation Bar -->
                <div class="eval-bar-container">
                    <div class="eval-score" id="evalScoreTop"></div>
                    <div class="eval-fill" id="evalFill"></div>
                    <div class="eval-score bottom" id="evalScoreBot">0.0</div>
                </div>

                <!-- Actual Board -->
                <div class="board-container-inner">
                    <div id="boardContainer"></div>
                </div>
            </div>

            <!-- Manual Input -->
            <div class="input-area">
                <input type="text" id="moveInput" placeholder="Move (e.g. e2e4)">
                <button class="btn btn-primary" onclick="recordMoveFromInput()">
                    <i class="ph-bold ph-paper-plane-right"></i>
                </button>
            </div>
            <div id="statusMessage" style="color: var(--accent-danger); font-size: 0.9rem; margin-top:5px; min-height: 1.2rem;"></div>
        </div>

        <!-- RIGHT PANEL: SIDEBAR -->
        <div class="sidebar">
            
            <div id="turnIndicator" class="status-card">
                <i class="ph-duotone ph-spinner-gap blink"></i> Loading...
            </div>

            <!-- NEW: Best Move Display -->
            <div id="bestMoveDisplay" class="status-card" style="border-color: var(--accent-success); color: var(--accent-success); margin-top: -15px;">
                <i class="ph-bold ph-lightning"></i> Best: Calculating...
            </div>

            <div class="terminal-window">
                <div class="terminal-header">
                    <span>ESP32 Stream</span>
                    <span style="color: #10b981"><i class="ph-bold ph-plugs-connected"></i> LIVE</span>
                </div>
                <div class="terminal-content">
                    > <span id="hw-input">Signal Waiting...</span><span class="blink">_</span>
                </div>
            </div>

            <div class="history-container">
                <div class="history-header">
                    <span>Move Log</span>
                    <button class="btn btn-secondary" style="padding: 2px 8px; font-size: 0.7rem;" onclick="copyPGN()">
                        <i class="ph-bold ph-copy"></i> PGN
                    </button>
                </div>
                <div class="history-list" id="moveHistory"></div>
            </div>

            <button class="btn btn-danger" onclick="startNewGame()">
                <i class="ph-bold ph-trash"></i> Reset Game
            </button>
        </div>

    </div>

    <script>
        // *****************************************************************
        // 1. CONFIGURATION
        // *****************************************************************
        const firebaseConfig = {
            apiKey: "AIzaSyA7CXPxD3GxvO3Fge6GV-85T_3Wjf840Rw",
            authDomain: "reattime-dba.firebaseapp.com",
            databaseURL: "https://reattime-dba-default-rtdb.firebaseio.com",
            projectId: "reattime-dba",
            storageBucket: "reattime-dba.firebasestorage.app",
            messagingSenderId: "526454581643",
            appId: "1:526454581643:web:a6f8ddeccef69ec42d278e",
            measurementId: "G-1NCZKB5L3B"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const gameRef = database.ref('chess_game');
        const hardwareInputRef = database.ref('chess_input/moveInput');

        let game = new Chess(); 
        let board = null;        
        const START_FEN = 'rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1';
        let isFlipped = false;
        
        // *****************************************************************
        // 2. STOCKFISH ENGINE
        // *****************************************************************
        let stockfish = null;

        function initStockfish() {
            const stockfishUrl = 'https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js';
            fetch(stockfishUrl).then(r => r.text()).then(txt => {
                const blob = new Blob([txt], { type: 'application/javascript' });
                stockfish = new Worker(URL.createObjectURL(blob));
                stockfish.onmessage = (e) => {
                    const line = e.data;
                    if (line.startsWith('info depth') && line.includes('score')) {
                        parseStockfishScore(line);
                    }
                    // Handle Best Move
                    if (line.startsWith('bestmove')) {
                        const move = line.split(' ')[1];
                        if(move) {
                            const bestMoveDisplay = document.getElementById('bestMoveDisplay');
                            bestMoveDisplay.innerHTML = `<i class="ph-bold ph-lightning"></i> Best: ${move}`;
                        }
                    }
                };
                stockfish.postMessage('uci');
                evaluatePosition(game.fen());
            });
        }

        function evaluatePosition(fen) {
            if (!stockfish) return;
            // Reset text while calculating
            document.getElementById('bestMoveDisplay').innerHTML = `<i class="ph-duotone ph-spinner-gap blink"></i> Calculating...`;
            stockfish.postMessage('position fen ' + fen);
            stockfish.postMessage('go depth 15');
        }

        function parseStockfishScore(line) {
            let score = 0.0, text = "0.0";
            const tokens = line.split(' ');
            const scoreIdx = tokens.indexOf('score');
            if (scoreIdx !== -1) {
                const type = tokens[scoreIdx + 1];
                const val = parseInt(tokens[scoreIdx + 2]);
                if (type === 'mate') {
                    score = val > 0 ? 1000 : -1000;
                    text = `M${Math.abs(val)}`;
                } else {
                    score = val;
                    text = (val / 100).toFixed(1);
                    if (val > 0) text = "+" + text;
                }
            }
            if (game.turn() === 'b') {
                score = -score;
                if(text !== "0.0" && !text.includes('M')) {
                    text = (parseFloat(text) * -1).toFixed(1);
                    if (parseFloat(text) > 0) text = "+" + text;
                }
            }
            updateEvalBar(score, text);
        }

        function updateEvalBar(score, text) {
            let percent = 50 + (score / 10);
            if (percent > 95) percent = 95;
            if (percent < 5) percent = 5;
            document.getElementById('evalFill').style.height = `${percent}%`;
            
            const top = document.getElementById('evalScoreTop');
            const bot = document.getElementById('evalScoreBot');
            if (score >= 0) {
                top.innerText = text; top.style.color = "#333"; bot.innerText = "";
            } else {
                bot.innerText = text; bot.style.color = "#fff"; top.innerText = "";
            }
        }

        // *****************************************************************
        // 3. AUDIO SYSTEM
        // *****************************************************************
        const BASE_DIR = 'Chess_board_audio/';
        const audioCache = {}; 
        let isAudioLoaded = false;
        let lastMoveCount = 0; 
        const pieceNames = { 'p': 'pawn', 'n': 'knight', 'b': 'bishop', 'r': 'rook', 'q': 'queen', 'k': 'king' };

        function preloadAllAudio() {
            document.getElementById('turnIndicator').innerHTML = '<i class="ph-duotone ph-download-simple"></i> Loading...';
            const paths = [];
            paths.push(`${BASE_DIR}color/white.mp3`, `${BASE_DIR}color/black.mp3`);
            Object.values(pieceNames).forEach(p => paths.push(`${BASE_DIR}piece/${p}.mp3`));
            ['a','b','c','d','e','f','g','h'].forEach(l => paths.push(`${BASE_DIR}position/letter/${l}.mp3`));
            ['1','2','3','4','5','6','7','8'].forEach(n => paths.push(`${BASE_DIR}position/number/${n}.mp3`));
            paths.push(`${BASE_DIR}action/takes.mp3`, `${BASE_DIR}action/check.mp3`, `${BASE_DIR}action/checkmate.mp3`);

            let loadedCount = 0;
            paths.forEach(path => {
                const audio = new Audio();
                audio.src = path;
                audio.preload = 'auto';
                const onDone = () => {
                    loadedCount++;
                    if (loadedCount >= paths.length && !isAudioLoaded) {
                        isAudioLoaded = true;
                        updateTurnIndicator(); 
                    }
                };
                audio.addEventListener('canplaythrough', onDone, { once: true });
                audio.onerror = onDone;
                audioCache[path] = audio;
            });
        }

        function playNextSound(soundPaths) {
            if (soundPaths.length === 0) return;
            const path = soundPaths.shift();
            const cachedAudio = audioCache[path];
            if (cachedAudio) {
                const soundToPlay = cachedAudio.cloneNode();
                soundToPlay.playbackRate = 1.2;
                soundToPlay.onended = () => playNextSound(soundPaths);
                soundToPlay.play().catch(() => playNextSound(soundPaths));
            } else {
                playNextSound(soundPaths);
            }
        }

        function speakMove(moveResult) {
            if (!isAudioLoaded) return;
            const piece = pieceNames[moveResult.piece];
            const color = (moveResult.color === 'w') ? 'white' : 'black';
            const dest = moveResult.to;
            
            const seq = [
                `${BASE_DIR}color/${color}.mp3`,
                `${BASE_DIR}piece/${piece}.mp3`,
                `${BASE_DIR}position/letter/${dest[0]}.mp3`,
                `${BASE_DIR}position/number/${dest[1]}.mp3`
            ];
            
            if (moveResult.captured) seq.splice(2, 0, `${BASE_DIR}action/takes.mp3`); 
            if (moveResult.san.includes('#')) seq.push(`${BASE_DIR}action/checkmate.mp3`);
            else if (moveResult.san.includes('+')) seq.push(`${BASE_DIR}action/check.mp3`);

            playNextSound(seq);
        }

        // *****************************************************************
        // 4. LOGIC
        // *****************************************************************
        
        hardwareInputRef.on('value', (snapshot) => {
            const moveString = snapshot.val();
            if (!moveString || moveString.trim() === "") return;
            const hwDisplay = document.getElementById('hw-input');
            hwDisplay.innerText = moveString;
            hwDisplay.style.color = "#34d399";
            setTimeout(() => hwDisplay.style.color = "#10b981", 300);
            processMove(moveString);
            hardwareInputRef.set(""); 
        });

        function processMove(moveString) {
            document.getElementById('statusMessage').textContent = ''; 
            const cleanMove = moveString.replace(/\s+/g, '');
            let tempGame = new Chess(game.fen());
            const moveResult = tempGame.move(cleanMove, { sloppy: true });

            if (moveResult === null) {
                document.getElementById('statusMessage').textContent = `Invalid: "${cleanMove}"`;
                return null;
            }

            const newFen = tempGame.fen();
            const playerColor = (game.turn() === 'w') ? 'White' : 'Black';
            evaluatePosition(newFen);

            gameRef.once('value').then(snapshot => {
                const currentData = snapshot.val() || {};
                let currentMoves = currentData.moves || [];
                if (typeof currentMoves === 'object') currentMoves = Object.values(currentMoves);

                currentMoves.push({
                    player: playerColor,
                    move: moveResult.san,
                    fen: newFen,
                    timestamp: Date.now()
                });

                gameRef.update({ fen: newFen, moves: currentMoves });
            });
            return moveResult.san;
        }

        gameRef.on('value', (snapshot) => {
            const gameData = snapshot.val();
            if (!gameData) {
                game.load(START_FEN);
                board.position(START_FEN);
                updateHistoryUI([]);
                lastMoveCount = 0;
                updateTurnIndicator();
                updateEvalBar(0, "0.0");
                return;
            }

            const serverFen = gameData.fen || START_FEN;
            const serverMoves = gameData.moves ? Object.values(gameData.moves) : [];

            if (game.fen() === serverFen) {
                if (serverMoves.length !== lastMoveCount) {
                    updateHistoryUI(serverMoves);
                    lastMoveCount = serverMoves.length;
                }
                return; 
            }

            game.load(serverFen);
            board.position(serverFen, false); 
            updateTurnIndicator();
            evaluatePosition(serverFen);

            if (serverMoves.length > lastMoveCount) {
                const latestMove = serverMoves[serverMoves.length - 1];
                const previousFen = serverMoves.length > 1 ? serverMoves[serverMoves.length - 2].fen : START_FEN;
                const tempGame = new Chess(previousFen);
                const moveDetails = tempGame.move(latestMove.move);
                if (moveDetails) speakMove(moveDetails);
            }
            lastMoveCount = serverMoves.length;
            updateHistoryUI(serverMoves);
        });

        // *****************************************************************
        // 5. UI HELPERS
        // *****************************************************************

        function changeTheme(themeClass) { document.body.className = themeClass; }
        function flipBoard() { board.flip(); isFlipped = !isFlipped; }
        function copyPGN() { navigator.clipboard.writeText(game.pgn()).then(() => alert("PGN Copied!")); }

        function updateTurnIndicator() {
            if (!isAudioLoaded) return; 
            const el = document.getElementById('turnIndicator');
            const turn = (game.turn() === 'w') ? 'White' : 'Black';
            
            if (game.in_checkmate()) {
                el.innerHTML = `<i class="ph-fill ph-trophy"></i> Checkmate! ${turn === 'White' ? 'Black' : 'White'} Wins!`;
                el.style.borderColor = "var(--accent-success)";
                el.style.color = "var(--accent-success)";
            } else if (game.in_draw()) {
                el.innerHTML = `<i class="ph-fill ph-handshake"></i> Draw`;
            } else {
                if (game.turn() === 'w') {
                    el.innerHTML = `<i class="ph-fill ph-circle"></i> White to Move`;
                    el.style.background = "rgba(255, 255, 255, 0.1)";
                    el.style.color = "#fff";
                    el.style.borderColor = "#fff";
                } else {
                    el.innerHTML = `<i class="ph-fill ph-circle-half"></i> Black to Move`;
                    el.style.background = "rgba(0, 0, 0, 0.3)";
                    el.style.color = "#94a3b8";
                    el.style.borderColor = "#94a3b8";
                }
            }
        }

        function updateHistoryUI(movesArray) {
            const list = document.getElementById('moveHistory');
            list.innerHTML = ''; 
            let row = null;
            let moveNum = 1;
            movesArray.forEach((moveData, index) => {
                if (index % 2 === 0) {
                    row = document.createElement('div');
                    row.className = 'history-row';
                    row.innerHTML = `<span class="move-num">${moveNum}.</span><span class="move-white">${moveData.move}</span>`;
                    list.appendChild(row);
                    moveNum++;
                } else {
                    if (row) {
                        const blackSpan = document.createElement('span');
                        blackSpan.className = 'move-black';
                        blackSpan.innerText = moveData.move;
                        row.appendChild(blackSpan);
                    }
                }
            });
            list.scrollTop = list.scrollHeight;
        }

        function recordMoveFromInput() {
            const val = document.getElementById('moveInput').value.trim();
            if(val) { processMove(val); document.getElementById('moveInput').value = ''; }
        }

        function startNewGame() {
            if (confirm("Reset Game?")) { gameRef.set(null); lastMoveCount = 0; updateEvalBar(0, "0.0"); }
        }

        function onDragStart (source, piece) {
            if (game.game_over()) return false;
            if (piece.search(game.turn() === 'w' ? /^b/ : /^w/) !== -1) return false;
        }
        function onDrop (source, target) {
            let moveString = source + target;
            const piece = game.get(source);
            if (piece && piece.type === 'p' && (target[1] === '8' || target[1] === '1')) moveString += 'q'; 
            const result = processMove(moveString);
            if (result === null) return 'snapback';
        }
        function onSnapEnd () {}

        $(document).ready(function() {
            const cfg = {
                draggable: true,
                position: START_FEN,
                onDragStart: onDragStart,
                onDrop: onDrop,
                onSnapEnd: onSnapEnd,
                dropOffBoard: 'snapback',
                pieceTheme: 'img/pieces/{piece}.png'
            };
            board = Chessboard('boardContainer', cfg);
            
            // AGGRESSIVE RESIZE LISTENER
            window.addEventListener('resize', () => {
                board.resize();
            });
            
            // Initial resize with delay to ensure rendering
            setTimeout(board.resize, 250);

            preloadAllAudio();
            initStockfish();
        });
    </script>
</body>
</html>